<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My To-Do Lists</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
        font-family: 'Poppins', sans-serif;
      }
      .offcanvas-body {
        padding: 0;
      }
      .list-group-item,
      .list-item,
      .title-container {
        cursor: pointer;
        touch-action: none;
      }
      .sortable-ghost {
        background-color: #e9ecef !important;
        opacity: 0.7;
      }
      .sortable-drag {
        opacity: 0.9;
        transform: scale(1.02);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
      }
      .offcanvas-title {
        cursor: pointer;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .offcanvas-title input {
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        padding: 0.25rem 0.5rem;
        width: 75%;
      }
      .list-group-item input {
        border: none;
        background: transparent;
        font-weight: 500;
        font-size: 1.25rem;
        width: 100%;
      }
      .list-group-item .list-item-text {
        cursor: pointer;
      }
      .add-item-form {
        display: flex;
        gap: 5px;
        margin-top: 15px;
      }
      .add-item-form .form-control {
        border-radius: 20px; /* Rounded input for mobile look */
        padding: 10px 15px;
      }
      .add-item-form .btn-add-item {
        border-radius: 20px;
        padding: 10px 15px;
      }
      .item-text,
      .list-name,
      .title-text {
        flex-grow: 1;
      }
      .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #ffffff; /* Solid white for tile effect */
        border: none; /* Remove border */
        border-radius: 8px; /* Rounded corners */
        padding: 15px; /* Larger padding */
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow for elevation */
        transition: background-color 0.2s ease-in-out;
      }
      .title-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f8f9fa;
        border: none;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 8px;
        transition: background-color 0.2s ease-in-out;
      }
      .list-item:hover,
      .title-container:hover {
        background-color: #f1f3f5; /* Subtle hover effect */
      }
      .list-item .item-actions,
      .title-container .title-actions {
        display: flex;
        gap: 5px;
        visibility: hidden;
      }
      .list-item:hover .item-actions,
      .title-container:hover .title-actions {
        visibility: visible;
      }
      .item-actions .btn,
      .title-actions .btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
      }
      #itemsList {
        padding-left: 0;
      }
      .import-export-buttons {
        padding: 1rem;
        border-top: 1px solid #e9ecef;
      }
      #currentListHeader {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin-bottom: 0.5rem;
      }
      .title-text {
        font-size: 1.5rem;
        margin-bottom: 0;
      }
      header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
      }
    </style>
  </head>
  <body>
    <div
      class="offcanvas offcanvas-end"
      tabindex="-1"
      id="offcanvasLists"
      aria-labelledby="offcanvasListsLabel"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasListsLabel">Your Lists</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body">
        <div class="input-group p-3 border-bottom">
          <input
            type="text"
            class="form-control"
            id="newListName"
            placeholder="Add new list..."
          />
          <button class="btn btn-primary" id="addListBtn">
            <i class="fas fa-plus"></i>
          </button>
        </div>
        <ul class="list-group list-group-flush" id="listsMenu"></ul>
        <div class="import-export-buttons d-flex justify-content-center gap-2">
          <button class="btn btn-secondary" id="exportBtn">
            <i class="fas fa-download me-1"></i>Export Data
          </button>
          <button class="btn btn-secondary" id="importBtn">
            <i class="fas fa-upload me-1"></i>Import Data
          </button>
          <input
            type="file"
            id="importFile"
            class="d-none"
            accept="application/json"
          />
        </div>
      </div>
    </div>
    <div class="container py-3">
      <header class="d-flex justify-content-between align-items-start mb-4">
        <div id="currentListHeader"></div>
        <button
          class="btn btn-outline-primary"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#offcanvasLists"
          aria-controls="offcanvasLists"
        >
          <i class="fas fa-bars"></i> Lists
        </button>
      </header>
      <ul class="list-items" id="itemsList"></ul>
      <div class="add-item-form mt-3">
        <input
          type="text"
          class="form-control add-item-input"
          placeholder="Add new item..."
        />
        <button class="btn btn-success btn-add-item">
          <i class="fas fa-plus"></i>
        </button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
      let todoData = { lists: [], items: [] };
      let currentListId = null;

      const listsMenu = document.getElementById("listsMenu");
      const newListNameInput = document.getElementById("newListName");
      const addListBtn = document.getElementById("addListBtn");
      const itemsList = document.getElementById("itemsList");
      const currentListHeader = document.getElementById("currentListHeader");
      const addItemInput = document.querySelector(".add-item-input");
      const addItemBtn = document.querySelector(".btn-add-item");
      const exportBtn = document.getElementById("exportBtn");
      const importBtn = document.getElementById("importBtn");
      const importFile = document.getElementById("importFile");

      function saveData() {
        localStorage.setItem("todoData", JSON.stringify(todoData));
      }

      function loadData() {
        const savedData = localStorage.getItem("todoData");
        if (savedData) todoData = JSON.parse(savedData);
        sortData();
        renderListsMenu();
        if (todoData.lists.length > 0) {
          switchToList(todoData.lists[0].id);
        }
      }

      function sortData() {
        todoData.lists.sort((a, b) => a.position - b.position);
        todoData.items.sort((a, b) => a.position - b.position);
      }

      function renderListsMenu() {
        listsMenu.innerHTML = "";
        todoData.lists.forEach((list) => {
          const listHtml = createListMenuItem(list);
          listsMenu.appendChild(listHtml);
        });
      }

      function createListMenuItem(list) {
        const listItem = document.createElement("li");
        listItem.className =
          "list-group-item d-flex justify-content-between align-items-center";
        listItem.setAttribute("data-list-id", list.id);
        listItem.innerHTML = `<span class="list-name">${list.name}</span>`;
        listItem.addEventListener("click", () => switchToList(list.id));
        return listItem;
      }

      function switchToList(listId) {
        currentListId = listId;
        const list = todoData.lists.find((l) => l.id === listId);
        if (list) {
          currentListHeader.innerHTML = `
            <div class="title-container" data-list-id="${list.id}">
              <h1 class="title-text text-primary">${list.name}</h1>
              <div class="title-actions">
                <button class="btn btn-sm btn-info edit-title-btn" title="Edit Title"><i class="fas fa-pencil-alt"></i></button>
                <button class="btn btn-sm btn-danger delete-title-btn" title="Delete List"><i class="fas fa-trash"></i></button>
              </div>
            </div>`;
          renderItems(listId);
        }
        const offcanvas = bootstrap.Offcanvas.getInstance(
          document.getElementById("offcanvasLists")
        );
        if (offcanvas) offcanvas.hide();
      }

      function renderItems(listId) {
        itemsList.innerHTML = "";
        const listItems = todoData.items.filter(
          (item) => item.list_id === listId
        );
        listItems.forEach((item) => {
          const itemHtml = createItemHtml(item);
          itemsList.appendChild(itemHtml);
        });
      }

      function createItemHtml(item) {
        const listItem = document.createElement("li");
        listItem.className = "list-item";
        listItem.setAttribute("data-item-id", item.id);
        listItem.innerHTML = `
          <i class="fas fa-grip-vertical me-2"></i>
          <span class="item-text">${item.text}</span>
          <div class="item-actions">
            <button class="btn btn-sm btn-info edit-item-btn" title="Edit Item"><i class="fas fa-pencil-alt"></i></button>
            <button class="btn btn-sm btn-danger delete-item-btn" title="Delete Item"><i class="fas fa-trash"></i></button>
          </div>`;
        return listItem;
      }

      function addEventListeners() {
        addListBtn.addEventListener("click", () => {
          const name = newListNameInput.value.trim();
          if (name) {
            addList(name);
            newListNameInput.value = "";
          }
        });
        newListNameInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            const name = newListNameInput.value.trim();
            if (name) {
              addList(name);
              newListNameInput.value = "";
            }
          }
        });
        addItemBtn.addEventListener("click", () => {
          const text = addItemInput.value.trim();
          if (text && currentListId !== null) {
            addItem(currentListId, text);
            addItemInput.value = "";
          }
        });
        addItemInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            const text = addItemInput.value.trim();
            if (text && currentListId !== null) {
              addItem(currentListId, text);
              addItemInput.value = "";
            }
          }
        });
        document.addEventListener("click", (e) => {
          if (e.target.closest(".edit-title-btn") && currentListId !== null) {
            toggleInLineEdit("list", currentListId);
          }
          if (e.target.closest(".delete-title-btn") && currentListId !== null) {
            deleteList(currentListId);
          }
          if (e.target.closest(".edit-item-btn")) {
            const itemId = parseInt(
              e.target.closest(".list-item").dataset.itemId
            );
            toggleInLineEdit("item", itemId);
          }
          if (e.target.closest(".delete-item-btn")) {
            const itemId = parseInt(
              e.target.closest(".list-item").dataset.itemId
            );
            deleteItem(itemId);
          }
        });
        exportBtn.addEventListener("click", exportData);
        importBtn.addEventListener("click", () => importFile.click());
        importFile.addEventListener("change", importData);
      }

      function updateListPositions() {
        const reorderedListElements = Array.from(
          listsMenu.querySelectorAll(".list-group-item")
        );
        reorderedListElements.forEach((el, index) => {
          const listId = parseInt(el.dataset.listId);
          const listToUpdate = todoData.lists.find(
            (list) => list.id === listId
          );
          if (listToUpdate) listToUpdate.position = index + 1;
        });
        sortData();
        saveData();
      }

      function updateItemPositions() {
        const reorderedItemElements = Array.from(
          itemsList.querySelectorAll(".list-item")
        );
        reorderedItemElements.forEach((el, index) => {
          const itemId = parseInt(el.dataset.itemId);
          const itemToUpdate = todoData.items.find(
            (item) => item.id === itemId
          );
          if (itemToUpdate) itemToUpdate.position = index + 1;
        });
        sortData();
        saveData();
      }

      function initializeSortable() {
        new Sortable(listsMenu, {
          animation: 150,
          ghostClass: "sortable-ghost",
          dragClass: "sortable-drag",
          onEnd: function () {
            updateListPositions();
          },
        });
        new Sortable(itemsList, {
          animation: 150,
          ghostClass: "sortable-ghost",
          dragClass: "sortable-drag",
          onEnd: function () {
            updateItemPositions();
          },
        });
      }

      function toggleInLineEdit(type, id) {
        if (type === "list") {
          const list = todoData.lists.find((l) => l.id === id);
          if (!list) return;
          const titleContainer = document.querySelector(
            `.title-container[data-list-id="${id}"]`
          );
          const titleText = titleContainer.querySelector(".title-text");
          const originalName = titleText.textContent.replace(" 📝", "");
          const input = document.createElement("input");
          input.type = "text";
          input.value = originalName;
          input.className = "form-control";
          titleText.innerHTML = "";
          titleText.appendChild(input);
          input.focus();
          const saveEdit = () => {
            const newName = input.value.trim();
            if (newName && newName !== originalName) {
              editList(id, newName);
            } else {
              titleText.textContent = originalName;
            }
          };
          input.addEventListener("blur", saveEdit);
          input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              saveEdit();
            }
          });
        } else if (type === "item") {
          const item = todoData.items.find((i) => i.id === id);
          if (!item) return;
          const itemElement = document.querySelector(
            `.list-item[data-item-id="${id}"]`
          );
          const itemTextSpan = itemElement.querySelector(".item-text");
          const originalText = itemTextSpan.textContent;
          const input = document.createElement("input");
          input.type = "text";
          input.value = originalText;
          itemTextSpan.innerHTML = "";
          itemTextSpan.appendChild(input);
          input.focus();
          const saveEdit = () => {
            const newText = input.value.trim();
            if (newText && newText !== originalText) {
              editItem(id, newText);
            }
            itemTextSpan.innerHTML = newText || originalText;
          };
          input.addEventListener("blur", saveEdit);
          input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              saveEdit();
            }
          });
        }
      }

      function addList(name) {
        const newId =
          todoData.lists.length > 0
            ? Math.max(...todoData.lists.map((l) => l.id), 0) + 1
            : 1;
        todoData.lists.forEach((list) => (list.position += 1));
        todoData.lists.push({ id: newId, name, position: 1 });
        sortData();
        renderListsMenu();
        saveData();
        switchToList(newId);
      }

      function deleteList(id) {
        if (
          confirm(
            "Are you sure you want to delete this list and all its items?"
          )
        ) {
          todoData.lists = todoData.lists.filter((list) => list.id !== id);
          todoData.items = todoData.items.filter((item) => item.list_id !== id);
          renumberLists();
          renumberItems();
          renderListsMenu();
          saveData();
          if (currentListId === id) {
            if (todoData.lists.length > 0) {
              switchToList(todoData.lists[0].id);
            } else {
              currentListHeader.innerHTML = "";
              itemsList.innerHTML = "";
            }
          }
        }
      }

      function editList(id, newName) {
        const list = todoData.lists.find((l) => l.id === id);
        if (list) {
          list.name = newName;
          renderListsMenu();
          saveData();
          if (currentListId === id) {
            currentListHeader.innerHTML = `
              <div class="title-container" data-list-id="${id}">
                <h1 class="title-text text-primary">${newName}</h1>
                <div class="title-actions">
                  <button class="btn btn-sm btn-info edit-title-btn" title="Edit Title"><i class="fas fa-pencil-alt"></i></button>
                  <button class="btn btn-sm btn-danger delete-title-btn" title="Delete List"><i class="fas fa-trash"></i></button>
                </div>
              </div>`;
          }
        }
      }

      function addItem(listId, text) {
        const newId =
          todoData.items.length > 0
            ? Math.max(...todoData.items.map((i) => i.id), 0) + 1
            : 1;
        const listItems = todoData.items.filter(
          (item) => item.list_id === listId
        );
        const newPosition =
          listItems.length > 0
            ? Math.max(...listItems.map((i) => i.position)) + 1
            : 1;
        todoData.items.push({
          id: newId,
          list_id: listId,
          text,
          position: newPosition,
        });
        sortData();
        renderItems(listId);
        saveData();
      }

      function deleteItem(id) {
        todoData.items = todoData.items.filter((item) => item.id !== id);
        renumberItems();
        renderItems(currentListId);
        saveData();
      }

      function editItem(id, newText) {
        const item = todoData.items.find((i) => i.id === id);
        if (item) {
          item.text = newText;
          saveData();
        }
        renderItems(currentListId);
      }

      function renumberLists() {
        todoData.lists.forEach((list, index) => {
          list.position = index + 1;
        });
      }

      function renumberItems() {
        const listIds = todoData.lists.map((l) => l.id);
        listIds.forEach((listId) => {
          const itemsInList = todoData.items
            .filter((item) => item.list_id === listId)
            .sort((a, b) => a.position - b.position);
          itemsInList.forEach((item, index) => {
            item.position = index + 1;
          });
        });
      }

      function exportData() {
        const dataStr = JSON.stringify(todoData, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "todo_data.json";
        a.click();
        URL.revokeObjectURL(url);
      }

      function importData(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const importedData = JSON.parse(event.target.result);
            if (importedData.lists && importedData.items) {
              todoData = importedData;
              sortData();
              renderListsMenu();
              if (todoData.lists.length > 0) {
                switchToList(todoData.lists[0].id);
              } else {
                currentListHeader.innerHTML = "";
                itemsList.innerHTML = "";
              }
              saveData();
              alert("Data imported successfully!");
            } else {
              alert("Invalid JSON file format.");
            }
          } catch (error) {
            alert("Failed to parse JSON file.");
          }
        };
        reader.readAsText(file);
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadData();
        addEventListeners();
        initializeSortable();
      });
    </script>
  </body>
</html>