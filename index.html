<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My To-Do Lists</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .offcanvas-body {
            padding: 0;
        }
        .list-group-item, .list-item {
            cursor: move;
        }
        .list-group-item.dragging, .list-item.dragging {
            background-color: #e9ecef;
            opacity: 0.9;
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: transform 0.1s ease, opacity 0.1s ease;
        }
        .offcanvas-title {
            cursor: pointer;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .offcanvas-title input {
            border: 1px solid #ced4da;
            border-radius: .25rem;
            padding: 0.25rem 0.5rem;
            width: 75%;
        }
        .list-group-item input {
            border: none;
            background: transparent;
            font-weight: bold;
            font-size: 1.25rem;
            width: 100%;
        }
        .list-group-item .list-item-text {
            cursor: pointer;
        }
        .add-item-form {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .item-text, .list-name {
            flex-grow: 1;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: move;
            transition: background-color 0.2s ease-in-out;
        }
        .list-item:hover {
            background-color: #dee2e6;
        }
        .list-item .item-actions {
            display: flex;
            gap: 5px;
            visibility: hidden;
        }
        .list-item:hover .item-actions {
            visibility: visible;
        }
        .item-actions .btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
        }
        .list-item-container {
            margin-top: 20px;
            border-radius: 10px;
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        #itemsList {
            padding-left: 0;
        }
    </style>
</head>
<body>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasLists" aria-labelledby="offcanvasListsLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasListsLabel">Your Lists</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="input-group p-3 border-bottom">
                <input type="text" class="form-control" id="newListName" placeholder="Add new list...">
                <button class="btn btn-primary" id="addListBtn"><i class="fas fa-plus"></i></button>
            </div>
            <ul class="list-group list-group-flush" id="listsMenu">
            </ul>
        </div>
    </div>

    <div class="container py-4">
        <header class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="text-center mb-0 text-primary flex-grow-1">To-Do Lists üìù</h1>
            <button class="btn btn-outline-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasLists" aria-controls="offcanvasLists">
                <i class="fas fa-bars"></i> Lists
            </button>
        </header>
        
        <div class="import-export-buttons d-flex justify-content-center gap-2 mb-4">
            <button class="btn btn-secondary" id="exportBtn"><i class="fas fa-download me-1"></i>Export Data</button>
            <button class="btn btn-secondary" id="importBtn"><i class="fas fa-upload me-1"></i>Import Data</button>
            <input type="file" id="importFile" class="d-none" accept="application/json">
        </div>

        <div id="mainContent" class="list-item-container">
            <div id="currentListHeader" class="d-flex justify-content-between align-items-center mb-3">
                <h3 id="currentListName" class="list-name"></h3>
                <div>
                    <button class="btn btn-sm btn-outline-secondary edit-list-name-btn" title="Edit List Name"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger delete-list-btn" title="Delete List"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>
            <ul class="list-items" id="itemsList">
            </ul>
            <div class="add-item-form mt-auto">
                <input type="text" class="form-control add-item-input" placeholder="Add new item...">
                <button class="btn btn-success btn-add-item"><i class="fas fa-plus"></i></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const initialData = {
          "lists": [
            { "id": 14, "name": "Project (Hard Part Is Start)", "position": 1 },
            { "id": 1, "name": "Wants", "position": 2 },
            { "id": 8, "name": "Next Vehicle", "position": 3 },
            { "id": 13, "name": "Plan", "position": 4 },
            { "id": 2, "name": "Locations", "position": 5 },
            { "id": 4, "name": "CSS", "position": 6 },
            { "id": 12, "name": "Inner Favorites", "position": 7 },
            { "id": 3, "name": "Sports", "position": 8 },
            { "id": 9, "name": "List Ideas", "position": 9 },
            { "id": 5, "name": "TV Shows", "position": 10 },
            { "id": 10, "name": "Feel Good", "position": 11 },
            { "id": 6, "name": "Top Friends", "position": 12 }
          ],
          "items": [
            { "id": 69, "list_id": 9, "text": "Songs To Perform", "position": 48 },
            { "id": 70, "list_id": 9, "text": "Current Job Pain Points", "position": 49 },
            { "id": 71, "list_id": 9, "text": "Past Job Ranked", "position": 50 },
            { "id": 72, "list_id": 9, "text": "New Job Requirements", "position": 51 },
            { "id": 73, "list_id": 9, "text": "Job Options", "position": 52 },
            { "id": 74, "list_id": 9, "text": "Bands", "position": 53 },
            { "id": 75, "list_id": 9, "text": "Restaurants", "position": 54 },
            { "id": 76, "list_id": 9, "text": "Best Vacations", "position": 55 },
            { "id": 82, "list_id": 10, "text": "Getting The Job Done", "position": 57 },
            { "id": 20, "list_id": 3, "text": "Pickle-balls", "position": 1 },
            { "id": 21, "list_id": 3, "text": "Foosball", "position": 2 },
            { "id": 22, "list_id": 3, "text": "Pingpong", "position": 3 },
            { "id": 23, "list_id": 3, "text": "Mountain Biking", "position": 4 },
            { "id": 26, "list_id": 3, "text": "Kickball", "position": 6 },
            { "id": 25, "list_id": 3, "text": "Cornhole", "position": 7 },
            { "id": 98, "list_id": 12, "text": "Projects", "position": 1 },
            { "id": 84, "list_id": 12, "text": "Insights", "position": 2 },
            { "id": 85, "list_id": 12, "text": "Mastery", "position": 3 },
            { "id": 86, "list_id": 12, "text": "Learning", "position": 4 },
            { "id": 14, "list_id": 2, "text": "West Knoxville", "position": 1 },
            { "id": 13, "list_id": 2, "text": "Maryville", "position": 2 },
            { "id": 12, "list_id": 2, "text": "Clearwater", "position": 3 },
            { "id": 11, "list_id": 2, "text": "Wesley Chapel", "position": 4 },
            { "id": 36, "list_id": 5, "text": "The Walking Dead Up To Season 4", "position": 1 },
            { "id": 37, "list_id": 5, "text": "Game Of Thrones", "position": 2 },
            { "id": 38, "list_id": 5, "text": "White Lotus", "position": 3 },
            { "id": 39, "list_id": 5, "text": "Breaking Bad", "position": 4 },
            { "id": 40, "list_id": 5, "text": "Spartacus", "position": 5 },
            { "id": 41, "list_id": 5, "text": "Obsession", "position": 6 },
            { "id": 42, "list_id": 5, "text": "Fortitude Season 1", "position": 7 },
            { "id": 43, "list_id": 5, "text": "Dard Desire Season 1", "position": 8 },
            { "id": 44, "list_id": 5, "text": "Lost Season 1", "position": 9 },
            { "id": 45, "list_id": 5, "text": "The Last Of Us Season 1", "position": 10 },
            { "id": 99, "list_id": 8, "text": "Model Y", "position": 1 },
            { "id": 101, "list_id": 8, "text": "Model 3", "position": 2 },
            { "id": 77, "list_id": 8, "text": "Tiguan", "position": 3 },
            { "id": 93, "list_id": 8, "text": "Jetta", "position": 4 },
            { "id": 90, "list_id": 8, "text": "Rav4", "position": 6 },
            { "id": 67, "list_id": 8, "text": "CR-V", "position": 7 },
            { "id": 59, "list_id": 8, "text": "Elantra", "position": 8 },
            { "id": 60, "list_id": 8, "text": "Tucson", "position": 9 },
            { "id": 62, "list_id": 8, "text": "Sonata", "position": 10 },
            { "id": 92, "list_id": 8, "text": "Tacoma", "position": 11 },
            { "id": 87, "list_id": 13, "text": "Hybrid Web Dev Job In Knoxville", "position": 1 },
            { "id": 97, "list_id": 13, "text": "$80k", "position": 2 },
            { "id": 94, "list_id": 13, "text": "15 Vacation", "position": 3 },
            { "id": 95, "list_id": 13, "text": "Health Insurance", "position": 4 },
            { "id": 96, "list_id": 13, "text": "401k", "position": 5 },
            { "id": 46, "list_id": 6, "text": "Richard", "position": 1 },
            { "id": 47, "list_id": 6, "text": "Alwyn", "position": 2 },
            { "id": 48, "list_id": 6, "text": "Simon", "position": 3 },
            { "id": 49, "list_id": 6, "text": "Stephen", "position": 4 },
            { "id": 50, "list_id": 6, "text": "Gerrit", "position": 5 },
            { "id": 51, "list_id": 6, "text": "Luiz", "position": 6 },
            { "id": 52, "list_id": 6, "text": "Chris", "position": 7 },
            { "id": 53, "list_id": 6, "text": "Bryan", "position": 8 },
            { "id": 2, "list_id": 1, "text": "Healthy Family", "position": 1 },
            { "id": 3, "list_id": 1, "text": "Family Financial Secure", "position": 2 },
            { "id": 8, "list_id": 1, "text": "Project", "position": 3 },
            { "id": 6, "list_id": 1, "text": "Pickleball", "position": 4 },
            { "id": 5, "list_id": 1, "text": "Chatting With Mates", "position": 5 },
            { "id": 4, "list_id": 1, "text": "PAW", "position": 6 },
            { "id": 7, "list_id": 1, "text": "Insights", "position": 7 },
            { "id": 1, "list_id": 1, "text": "F T", "position": 8 },
            { "id": 28, "list_id": 4, "text": ".t {}", "position": 1 },
            { "id": 27, "list_id": 4, "text": ".pa {}", "position": 2 },
            { "id": 29, "list_id": 4, "text": ".sk {}", "position": 3 },
            { "id": 30, "list_id": 4, "text": ".em {}", "position": 4 },
            { "id": 31, "list_id": 4, "text": ".tr {}", "position": 5 },
            { "id": 32, "list_id": 4, "text": ".me {}", "position": 6 },
            { "id": 33, "list_id": 4, "text": ".mi {}", "position": 7 },
            { "id": 34, "list_id": 4, "text": ".ze {}", "position": 8 },
            { "id": 35, "list_id": 4, "text": ".ke {}", "position": 9 },
            { "id": 102, "list_id": 14, "text": "Clean Upstairs", "position": 1 },
            { "id": 103, "list_id": 14, "text": "Work On Brighton Bank", "position": 4 },
            { "id": 108, "list_id": 14, "text": "Work On Cards For Website", "position": 5 },
            { "id": 104, "list_id": 14, "text": "Wash Car", "position": 6 }
          ]
        };
        
        let todoData;
        let currentListId = null;

        const listsMenu = document.getElementById('listsMenu');
        const newListNameInput = document.getElementById('newListName');
        const addListBtn = document.getElementById('addListBtn');
        const itemsList = document.getElementById('itemsList');
        const currentListNameHeader = document.getElementById('currentListName');
        const addItemInput = document.querySelector('.add-item-input');
        const addItemBtn = document.querySelector('.btn-add-item');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        const deleteListBtn = document.querySelector('.delete-list-btn');
        const editListNameBtn = document.querySelector('.edit-list-name-btn');

        let draggedElement = null;
        let isDragging = false;

        // Function to save data to local storage
        function saveData() {
            localStorage.setItem('todoData', JSON.stringify(todoData));
        }

        // Function to load data from local storage or use initial data
        function loadData() {
            const savedData = localStorage.getItem('todoData');
            if (savedData) {
                todoData = JSON.parse(savedData);
            } else {
                todoData = initialData;
            }
            sortData();
            renderListsMenu();
            if (todoData.lists.length > 0) {
                switchToList(todoData.lists[0].id);
            }
        }

        // Sort lists and items by their position property
        function sortData() {
            todoData.lists.sort((a, b) => a.position - b.position);
            todoData.items.sort((a, b) => a.position - b.position);
        }

        // Render the lists in the hamburger menu
        function renderListsMenu() {
            listsMenu.innerHTML = '';
            todoData.lists.forEach(list => {
                const listHtml = createListMenuItem(list);
                listsMenu.appendChild(listHtml);
            });
            addListDragListeners();
        }

        // Create a single list menu item
        function createListMenuItem(list) {
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            listItem.setAttribute('data-list-id', list.id);
            listItem.setAttribute('draggable', 'true');
            listItem.innerHTML = `
                <i class="fas fa-grip-vertical me-2"></i>
                <span class="list-name">${list.name}</span>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary edit-list-btn d-none" title="Edit List Name"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger delete-list-btn-menu d-none" title="Delete List"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;
            listItem.addEventListener('click', (e) => {
                // Prevent switching list when clicking edit/delete buttons
                if (e.target.closest('.btn-group')) {
                    e.stopPropagation();
                    return;
                }
                if (!isDragging) {
                    switchToList(list.id);
                }
            });
            return listItem;
        }

        // Switch to and render a specific list
        function switchToList(listId) {
            currentListId = listId;
            const list = todoData.lists.find(l => l.id === listId);
            if (list) {
                currentListNameHeader.textContent = list.name;
                renderItems(listId);
            }
            // Close the offcanvas menu on mobile
            const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasLists'));
            if (offcanvas) {
                offcanvas.hide();
            }
        }
        
        // Render the items for the current list
        function renderItems(listId) {
            itemsList.innerHTML = '';
            const listItems = todoData.items.filter(item => item.list_id === listId);
            listItems.forEach(item => {
                const itemHtml = createItemHtml(item);
                itemsList.appendChild(itemHtml);
            });
            addItemDragListeners();
        }

        // Create HTML for a single item
        function createItemHtml(item) {
            const listItem = document.createElement('li');
            listItem.className = 'list-item';
            listItem.setAttribute('data-item-id', item.id);
            listItem.setAttribute('draggable', 'true');
            listItem.innerHTML = `
                <i class="fas fa-grip-vertical me-2"></i>
                <span class="item-text">${item.text}</span>
                <div class="item-actions">
                    <button class="btn btn-sm btn-info edit-item-btn" title="Edit Item"><i class="fas fa-pencil-alt"></i></button>
                    <button class="btn btn-sm btn-danger delete-item-btn" title="Delete Item"><i class="fas fa-trash"></i></button>
                </div>
            `;
            return listItem;
        }

        // Add event listeners for CRUD operations
        function addEventListeners() {
            // Add new list
            addListBtn.addEventListener('click', () => {
                const name = newListNameInput.value.trim();
                if (name) {
                    addList(name);
                    newListNameInput.value = '';
                }
            });

            // Add new item
            addItemBtn.addEventListener('click', () => {
                const text = addItemInput.value.trim();
                if (text && currentListId !== null) {
                    addItem(currentListId, text);
                    addItemInput.value = '';
                }
            });

            // Edit and Delete List/Item
            document.addEventListener('click', (e) => {
                // Edit List Name in main view
                if (e.target.closest('.edit-list-name-btn') && currentListId !== null) {
                    toggleInLineEdit('list', currentListId);
                }
                // Delete List from main view
                if (e.target.closest('.delete-list-btn') && currentListId !== null) {
                    deleteList(currentListId);
                }
                // Delete List from menu
                if (e.target.closest('.delete-list-btn-menu')) {
                    const listId = parseInt(e.target.closest('[data-list-id]').dataset.listId);
                    deleteList(listId);
                }
                // Edit Item
                if (e.target.closest('.edit-item-btn')) {
                    const itemId = parseInt(e.target.closest('.list-item').dataset.itemId);
                    toggleInLineEdit('item', itemId);
                }
                // Delete Item
                if (e.target.closest('.delete-item-btn')) {
                    const itemId = parseInt(e.target.closest('.list-item').dataset.itemId);
                    deleteItem(itemId);
                }
            });

            // Export data
            exportBtn.addEventListener('click', exportData);
            
            // Import data
            importBtn.addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', importData);
        }

        // Toggle in-line editing for list or item
        function toggleInLineEdit(type, id) {
            if (type === 'list') {
                const list = todoData.lists.find(l => l.id === id);
                if (!list) return;

                const originalName = currentListNameHeader.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = originalName;
                input.className = 'form-control';
                
                currentListNameHeader.innerHTML = '';
                currentListNameHeader.appendChild(input);
                input.focus();

                const saveEdit = () => {
                    const newName = input.value.trim();
                    if (newName && newName !== originalName) {
                        editList(id, newName);
                    }
                    currentListNameHeader.innerHTML = newName;
                };

                input.addEventListener('blur', saveEdit);
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveEdit();
                    }
                });
            } else if (type === 'item') {
                const item = todoData.items.find(i => i.id === id);
                if (!item) return;

                const itemElement = document.querySelector(`.list-item[data-item-id="${id}"]`);
                const itemTextSpan = itemElement.querySelector('.item-text');
                const originalText = itemTextSpan.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = originalText;
                
                itemTextSpan.innerHTML = '';
                itemTextSpan.appendChild(input);
                input.focus();

                const saveEdit = () => {
                    const newText = input.value.trim();
                    if (newText && newText !== originalText) {
                        editItem(id, newText);
                    }
                    itemTextSpan.innerHTML = newText;
                };

                input.addEventListener('blur', saveEdit);
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveEdit();
                    }
                });
            }
        }

        // Add drag-and-drop listeners for lists
        function addListDragListeners() {
            const listItems = listsMenu.querySelectorAll('.list-group-item');
            listItems.forEach(item => {
                // Desktop Drag & Drop
                item.addEventListener('dragstart', (e) => {
                    isDragging = true;
                    draggedElement = e.target.closest('.list-group-item');
                    e.dataTransfer.setData('text/plain', draggedElement.dataset.listId);
                    setTimeout(() => draggedElement.classList.add('dragging'), 0);
                });

                item.addEventListener('dragend', () => {
                    if (draggedElement) {
                        draggedElement.classList.remove('dragging');
                        draggedElement = null;
                        isDragging = false;
                    }
                });

                listsMenu.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(listsMenu, e.clientY);
                    const draggable = document.querySelector('.list-group-item.dragging');
                    if (draggable) {
                        if (afterElement == null) {
                            listsMenu.appendChild(draggable);
                        } else {
                            listsMenu.insertBefore(draggable, afterElement);
                        }
                    }
                });

                listsMenu.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (!draggedElement) return;
                    updateListPositions();
                    saveData();
                });

                // Mobile Touch Drag & Drop
                let startY = 0;
                let startTime = 0;
                let touchMoved = false;

                item.addEventListener('touchstart', (e) => {
                    e.stopPropagation();
                    startY = e.touches[0].clientY;
                    startTime = Date.now();
                    touchMoved = false;
                    draggedElement = e.target.closest('.list-group-item');
                    draggedElement.classList.add('dragging');

                    const handleTouchMove = (moveEvent) => {
                        moveEvent.preventDefault();
                        touchMoved = true;
                        const currentY = moveEvent.touches[0].clientY;
                        const deltaY = currentY - startY;

                        // Move the element visually
                        draggedElement.style.transform = `translateY(${deltaY}px)`;

                        // Find the element to insert after
                        const afterElement = getDragAfterElement(listsMenu, currentY);
                        if (draggedElement && draggedElement !== afterElement) {
                            if (afterElement == null) {
                                listsMenu.appendChild(draggedElement);
                            } else {
                                listsMenu.insertBefore(draggedElement, afterElement);
                            }
                        }
                    };

                    const handleTouchEnd = () => {
                        listsMenu.removeEventListener('touchmove', handleTouchMove);
                        listsMenu.removeEventListener('touchend', handleTouchEnd);

                        if (touchMoved && draggedElement) {
                            draggedElement.style.transform = '';
                            draggedElement.classList.remove('dragging');
                            updateListPositions();
                            saveData();
                        } else if (!touchMoved && Date.now() - startTime < 500) {
                            // Treat as a tap if no movement and short duration
                            switchToList(parseInt(draggedElement.dataset.listId));
                        }
                        draggedElement.classList.remove('dragging');
                        draggedElement = null;
                        isDragging = false;
                    };

                    listsMenu.addEventListener('touchmove', handleTouchMove, { passive: false });
                    listsMenu.addEventListener('touchend', handleTouchEnd);
                });
            });
        }

        // Add drag-and-drop listeners for items
        function addItemDragListeners() {
            const listItems = itemsList.querySelectorAll('.list-item');
            listItems.forEach(item => {
                // Desktop Drag & Drop
                item.addEventListener('dragstart', (e) => {
                    isDragging = true;
                    draggedElement = e.target.closest('.list-item');
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        itemId: draggedElement.dataset.itemId,
                        sourceListId: currentListId
                    }));
                    setTimeout(() => draggedElement.classList.add('dragging'), 0);
                });

                item.addEventListener('dragend', () => {
                    if (draggedElement) {
                        draggedElement.classList.remove('dragging');
                        draggedElement = null;
                        isDragging = false;
                    }
                });

                itemsList.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(itemsList, e.clientY);
                    const draggable = document.querySelector('.list-item.dragging');
                    if (draggable) {
                        if (afterElement == null) {
                            itemsList.appendChild(draggable);
                        } else {
                            itemsList.insertBefore(draggable, afterElement);
                        }
                    }
                });

                itemsList.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (!draggedElement) return;
                    updateItemPositions();
                    saveData();
                });

                // Mobile Touch Drag & Drop
                let startY = 0;
                let startTime = 0;
                let touchMoved = false;

                item.addEventListener('touchstart', (e) => {
                    e.stopPropagation();
                    startY = e.touches[0].clientY;
                    startTime = Date.now();
                    touchMoved = false;
                    draggedElement = e.target.closest('.list-item');
                    draggedElement.classList.add('dragging');

                    const handleTouchMove = (moveEvent) => {
                        moveEvent.preventDefault();
                        touchMoved = true;
                        const currentY = moveEvent.touches[0].clientY;
                        const deltaY = currentY - startY;

                        // Move the element visually
                        draggedElement.style.transform = `translateY(${deltaY}px)`;

                        // Find the element to insert after
                        const afterElement = getDragAfterElement(itemsList, currentY);
                        if (draggedElement && draggedElement !== afterElement) {
                            if (afterElement == null) {
                                itemsList.appendChild(draggedElement);
                            } else {
                                itemsList.insertBefore(draggedElement, afterElement);
                            }
                        }
                    };

                    const handleTouchEnd = () => {
                        itemsList.removeEventListener('touchmove', handleTouchMove);
                        itemsList.removeEventListener('touchend', handleTouchEnd);

                        if (touchMoved && draggedElement) {
                            draggedElement.style.transform = '';
                            draggedElement.classList.remove('dragging');
                            updateItemPositions();
                            saveData();
                        }
                        draggedElement.classList.remove('dragging');
                        draggedElement = null;
                        isDragging = false;
                    };

                    itemsList.addEventListener('touchmove', handleTouchMove, { passive: false });
                    itemsList.addEventListener('touchend', handleTouchEnd);
                });
            });
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.list-group-item:not(.dragging), .list-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // CRUD Functions
        function addList(name) {
            const newId = todoData.lists.length > 0 ? Math.max(...todoData.lists.map(l => l.id)) + 1 : 1;
            const newPosition = todoData.lists.length > 0 ? Math.max(...todoData.lists.map(l => l.position)) + 1 : 1;
            todoData.lists.push({ id: newId, name, position: newPosition });
            sortData();
            renderListsMenu();
            saveData();
            switchToList(newId);
        }

        function deleteList(id) {
            if (confirm('Are you sure you want to delete this list and all its items?')) {
                todoData.lists = todoData.lists.filter(list => list.id !== id);
                todoData.items = todoData.items.filter(item => item.list_id !== id);
                renumberLists();
                renumberItems();
                renderListsMenu();
                saveData();
                if (currentListId === id) {
                    if (todoData.lists.length > 0) {
                        switchToList(todoData.lists[0].id);
                    } else {
                        currentListNameHeader.textContent = '';
                        itemsList.innerHTML = '';
                    }
                }
            }
        }

        function editList(id, newName) {
            const list = todoData.lists.find(l => l.id === id);
            if (list) {
                list.name = newName;
                renderListsMenu();
                saveData();
            }
        }

        function addItem(listId, text) {
            const newId = todoData.items.length > 0 ? Math.max(...todoData.items.map(i => i.id)) + 1 : 1;
            const listItems = todoData.items.filter(item => item.list_id === listId);
            const newPosition = listItems.length > 0 ? Math.max(...listItems.map(i => i.position)) + 1 : 1;
            todoData.items.push({ id: newId, list_id: listId, text, position: newPosition });
            sortData();
            renderItems(listId);
            saveData();
        }

        function deleteItem(id) {
            todoData.items = todoData.items.filter(item => item.id !== id);
            renumberItems();
            renderItems(currentListId);
            saveData();
        }

        function editItem(id, newText) {
            const item = todoData.items.find(i => i.id === id);
            if (item) {
                item.text = newText;
                renderItems(currentListId);
                saveData();
            }
        }

        // Update positions of lists after a drag and drop action
        function updateListPositions() {
            const reorderedListElements = Array.from(listsMenu.querySelectorAll('.list-group-item'));
            const reorderedLists = reorderedListElements.map((el, index) => {
                return {
                    id: parseInt(el.dataset.listId),
                    position: index + 1
                };
            });
            reorderedLists.forEach(updatedList => {
                const listToUpdate = todoData.lists.find(list => list.id === updatedList.id);
                if (listToUpdate) {
                    listToUpdate.position = updatedList.position;
                }
            });
            renumberLists();
        }

        // Update positions of items after a drag and drop action
        function updateItemPositions() {
            const reorderedItemElements = Array.from(itemsList.querySelectorAll('.list-item'));
            const reorderedItems = reorderedItemElements.map((el, index) => {
                return {
                    id: parseInt(el.dataset.itemId),
                    position: index + 1,
                    list_id: currentListId
                };
            });
            reorderedItems.forEach(updatedItem => {
                const itemToUpdate = todoData.items.find(item => item.id === updatedItem.id);
                if (itemToUpdate) {
                    itemToUpdate.position = updatedItem.position;
                }
            });
            renumberItems();
        }

        // Re-number positions of lists after a change
        function renumberLists() {
            todoData.lists.forEach((list, index) => {
                list.position = index + 1;
            });
        }
        
        // Re-number positions of items after a change
        function renumberItems() {
            const listIds = todoData.lists.map(l => l.id);
            listIds.forEach(listId => {
                const itemsInList = todoData.items.filter(item => item.list_id === listId).sort((a, b) => a.position - b.position);
                itemsInList.forEach((item, index) => {
                    item.position = index + 1;
                });
            });
        }

        // Export data as JSON file
        function exportData() {
            const dataStr = JSON.stringify(todoData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'todo_data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import data from JSON file
        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    // Simple validation for required structure
                    if (importedData.lists && importedData.items) {
                        todoData = importedData;
                        sortData();
                        renderListsMenu();
                        switchToList(todoData.lists[0].id);
                        saveData();
                        alert('Data imported successfully!');
                    } else {
                        alert('Invalid JSON file format. Please import a valid file.');
                    }
                } catch (error) {
                    alert('Failed to parse JSON file.');
                }
            };
            reader.readAsText(file);
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            addEventListeners();
        });
    </script>
</body>
</html>